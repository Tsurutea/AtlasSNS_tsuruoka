<!-- src/main/resources/templates/topPage.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>トップ</title>
  <link rel="stylesheet" th:href="@{/css/reset.css}" />
  <link rel="stylesheet" th:href="@{/css/header.css}" />
  <link rel="stylesheet" th:href="@{/css/topPage.css}" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
</head>
<body>
  <header th:replace="fragments/header :: header"></header>

  <div class="two-col">
    <main class="main">
      <!-- 投稿フォーム -->
      <section>
        <form th:action="@{/newPost}" method="post" class="post-form">
          <div class="post-input">
            <!-- アイコン -->
            <th:block th:with="val=${session.userIconImage},
              hasVal=${!#strings.isEmpty(val)},
              isUser=${hasVal} ? ${#strings.startsWith(val,'/user-icons/')} : false,
              isImgAbs=${hasVal} ? ${#strings.startsWith(val,'/images/')} : false,
              iconPath=${!hasVal ? '/images/icon1.png' : (isUser || isImgAbs ? val : '/images/' + val)}">
              <a class="my-icon" th:if="${session.userId != null}" th:href="@{/users/{id}(id=${session.userId})}">
                <img th:src="${iconPath}" alt="アイコン" />
              </a>
              <img th:if="${session.userId == null}" th:src="${iconPath}" alt="アイコン" class="my-icon" />
            </th:block>
            <textarea class="textarea" maxlength="150" name="content" rows="4" cols="50" placeholder="投稿内容を入力してください"></textarea>
          </div>
          <button type="submit">
            <img th:src="@{/images/post.png}" alt="投稿" class="my-icon" />
          </button>
        </form>
      </section>

      <!-- 投稿一覧 -->
      <section>
        <div th:each="post : ${posts}" class="post-card" th:if="${post != null}">
          <div class="post-container">
            <div class="post-left">
              <th:block th:with="pimg=${post.user != null ? post.user.iconImage : null},
                hasVal=${!#strings.isEmpty(pimg)},
                isUser=${hasVal} ? ${#strings.startsWith(pimg,'/user-icons/')} : false,
                isImgAbs=${hasVal} ? ${#strings.startsWith(pimg,'/images/')} : false,
                iconPath=${!hasVal ? '/images/icon1.png' : (isUser || isImgAbs ? pimg : '/images/' + pimg)}">
                <a th:href="@{/users/{id}(id=${post.user.id})}">
                  <img th:src="${iconPath}" alt="アイコン" class="post-icon" />
                </a>
              </th:block>
              <div class="post-wrapper">
                <p><strong>
                  <a th:href="@{/users/{id}(id=${post.user.id})}" th:text="${post.user.name}">ユーザー名</a>
                </strong></p>
                <p class="post-content" th:text="${post.content}">投稿内容</p>
              </div>
            </div>

            <div class="post-right">
              <p class="post-time" th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}">投稿日時</p>
              <div th:if="${post.user != null and post.user.id == session.userId}" class="post-actions">
                <!-- 編集 -->
                <button type="button" class="edit-open-btn  edit-btn" th:attr="data-id=${post.id}, data-content=${post.content}">
                  
                </button>

                <!-- 削除 -->
                <button type="button" class="trash-btn delete-btn" th:attr="data-id=${post.id}">
                  
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- サイドバー -->
    <aside class="sidebar">
      <section class="follow-summary">
        <div class="follow-wrapper">
          <p class="user-name" th:text="${session.userName} + 'さんの'">ログインユーザーさんの</p>
          <div class="follow-count">
            <p>フォロー数　<span><span th:text="${followings.size()}">0</span>人</span></p>
            <form th:action="@{/followList}" method="get"><button type="submit">フォローリスト</button></form>
          </div>
          <div class="follow-count">
            <p>フォロワー数　<span><span th:text="${followers.size()}">0</span>人</span></p>
            <form th:action="@{/followerList}" method="get"><button type="submit">フォロワーリスト</button></form>
          </div>
        </div>
        <a th:href="@{/userSearch}" class="btn user-search">ユーザー検索</a>
      </section>
    </aside>
  </div>

  <!-- 編集モーダル -->
  <div id="editModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close edit-close" id="closeModalBtn">&times;</span>
      <form id="editForm" method="post" action="/editPost" class="edit-form">
        <input type="hidden" name="postId" id="editPostId" value="">
        <textarea class="textarea" name="content" id="editContent" rows="4" cols="50"></textarea>
        <button type="submit" class="edit-submit-btn">
          <img th:src="@{/images/edit.png}" alt="保存" class="edit-btn">
        </button>
      </form>
    </div>
  </div>

  <!-- 削除モーダル -->
  <div id="deleteModal" class="modal" style="display: none;">
    <div class="modal-content">
      <p>本当に削除しますか？</p>
      <form method="post" th:action="@{/deletePost}">
        <input type="hidden" name="postId" id="deletePostId" />
		<div class="delete-btn-wrapper">
        <button type="submit" id="confirmDeleteBtn">Ok</button>
        <button type="button" id="cancelDeleteBtn">キャンセル</button>
		</div>
      </form>
    </div>
  </div>

  <!-- スクリプト -->
  <script th:src="@{/js/header.js}"></script>
  <script th:src="@{/js/postEdit.js}"></script>
  <script th:src="@{/js/confirmDelete.js}"></script>
</body>
</html>